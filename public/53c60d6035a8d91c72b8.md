---
title: Node.js Test Runnerã¨ãƒ“ãƒ«ãƒˆã‚¤ãƒ³ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã¿ã§ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¢ãƒƒã‚¯ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚’ã¤ãã£ãŸ
tags:
  - JavaScript
  - Node.js
private: false
updated_at: '2023-07-13T23:47:19+09:00'
id: 53c60d6035a8d91c72b8
organization_url_name: qiita-inc
slide: false
---
## ã¯ã˜ã‚ã«

ä»¥ä¸‹ã®è¨˜äº‹ã§ã€Node.js Test Runnerã§ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚µãƒ–ã‚»ãƒƒãƒˆã‚’ãƒ¢ãƒƒã‚¯ã™ã‚‹æ–¹æ³•ã‚’æ›¸ãã¾ã—ãŸã€‚

https://qiita.com/ohakutsu/items/7145f083828df7f0e6e4

ã—ã‹ã—ã€ã‚µãƒ–ã‚»ãƒƒãƒˆã§ãªã„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ¢ãƒƒã‚¯ã‚‚ã—ãŸã„ã¨ããŒã‚ã‚‹ãªã¨æ€ã„èª¿ã¹ãŸã¨ã“ã‚ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¢ãƒƒã‚¯ã‚’ã§ãã‚‹ç°¡æ˜“çš„ãªãƒ˜ãƒ«ãƒ‘ãƒ¼ãŒã§ããŸã®ã§ç´¹ä»‹ã—ã¾ã™ã€‚

ãªãŠã€ä»Šå›è©¦ã™ã®ã¯CJSã§ã™ã€‚

## ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚’ä½¿ã£ã¦ãƒ†ã‚¹ãƒˆã™ã‚‹

ã‚µãƒ–ã‚»ãƒƒãƒˆã§ãªã„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆæ­£ã—ã„åå‰ãŒã‚ã‹ã‚‰ãªã„ï¼‰ã¨è¨€ã£ã¦ã„ã‚‹ã®ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‚‚ã®ã§ã™ã€‚

```js:add.js
module.exports = (a, b) => {
  return a + b;
};
```

ä»Šå›ã¯ã€ [`node-fetch`](https://github.com/node-fetch/node-fetch) ã§è©¦ã—ã¾ã™ã€‚

ãƒ†ã‚¹ãƒˆã—ãŸã„ã‚‚ã®ã¯ä»¥ä¸‹ã®`getExampleBody`é–¢æ•°ã§ã™ã€‚

```js:index.js
const fetch = require("node-fetch");

exports.getExampleBody = async () => {
  const response = await fetch("https://example.com");
  const body = await response.text();
  return body;
};
```

ã“ã®`getExampleBody`ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹éš›ã«ã€`fetch`ã§ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã•ã›ãŸããªã„ãŸã‚ã€`fetch`é–¢æ•°ã‚’ãƒ¢ãƒƒã‚¯ã—ãŸã„ã§ã™ã€‚

https://qiita.com/ohakutsu/items/7145f083828df7f0e6e4

ã®è¨˜äº‹ã§æ›¸ã„ãŸã‚ˆã†ã«ã€ã‚µãƒ–ã‚»ãƒƒãƒˆã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ [`mock.method`](https://nodejs.org/api/test.html#mockmethodobject-methodname-implementation-options) ã§ãƒ¢ãƒƒã‚¯ãŒã§ãã‚‹ã®ã§ã™ãŒã€ä»Šå›ã®å ´åˆã¯ã§ãã¾ã›ã‚“ã€‚

ãã“ã§æ€ã„ã¤ã„ãŸã®ãŒã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ­ãƒ¼ãƒ‰ã«ä»‹å…¥ã—ã¦ã€ãƒ¢ãƒƒã‚¯é–¢æ•°ã‚’è¿”ã™æ–¹æ³•ã§ã™ã€‚
å®Ÿéš›ã«æ›¸ã„ãŸãƒ˜ãƒ«ãƒ‘ãƒ¼ã¯ä»¥ä¸‹ã§ã™ã€‚

```js:module-mock-helper.js
const Module = require("node:module");

const mocks = {};

const originalJsLoader = Module._extensions[".js"];
Module._extensions[".js"] = function (mod, filename) {
  if (mocks[filename]) {
    mod.exports = mocks[filename];
  } else {
    originalJsLoader(mod, filename);
  }
};

exports.mockModule = (name, fn) => {
  const filename = require.resolve(name);
  mocks[filename] = fn;
  delete require.cache[filename];

  return fn;
};
```

ä½¿ã„æ–¹ã¯ç°¡å˜ã§ã€`mockModule`ã®ç¬¬ä¸€å¼•æ•°ã«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åã€ç¬¬äºŒå¼•æ•°ã«ãƒ¢ãƒƒã‚¯é–¢æ•°ã‚’æ¸¡ã™ã ã‘ã§ã™ã€‚

ã“ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚’ä½¿ã£ã¦æ›¸ã„ãŸãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚

```js:index.test.js
const { test, mock } = require("node:test");
const assert = require("node:assert");
const { mockModule } = require("./module-mock-helper");
const fetch = require("node-fetch");

const mockFetch = mockModule(
  "node-fetch",
  mock.fn(fetch, async () => {
    return {
      text: async () => {
        return "sample body";
      },
    };
  }),
);

const { getExampleBody } = require("./index");

test("getExampleBody with mock", async () => {
  const body = await getExampleBody();
  assert.equal(body, "sample body");
  assert.equal(mockFetch.mock.callCount(), 1);
});
```

`mockModule`ã®ä»•çµ„ã¿ã¯ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ­ãƒ¼ãƒ‰ã«ä»‹å…¥ã—ã€ãƒ¢ãƒƒã‚¯é–¢æ•°ã‚’è¿”ã™ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

`mockModule`ã§æ¸¡ã•ã‚ŒãŸãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åã‹ã‚‰ãƒ‘ã‚¹ã‚’å–å¾—ã—ã€ãã®ãƒ‘ã‚¹ã‚’keyã¨ã—ã¦æ¸¡ã•ã‚ŒãŸãƒ¢ãƒƒã‚¯é–¢æ•°ã‚’è¨˜æ†¶ã—ã¦ãŠãã¾ã™ã€‚
ãã—ã¦ã€`Module._extensions`ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã€è¨˜æ†¶ã—ã¦ã„ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã‚ˆã†ã¨ã—ãŸéš›ã«ãƒ¢ãƒƒã‚¯é–¢æ•°ã‚’è¿”ã™ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

## ã•ã„ã”ã«

ç„¡äº‹ã€ãƒ“ãƒ«ãƒˆã‚¤ãƒ³ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã ã‘ã§ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¢ãƒƒã‚¯ãŒã§ãã¾ã—ãŸã€‚
ãŸã ã€Native ESMã®å ´åˆã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ­ãƒ¼ãƒ‰å‘¨ã‚ŠãŒã‚ã‹ã‚‰ãªã„ã®ã§ã€æ¬¡å›æŒ‘æˆ¦ã™ã‚‹ãªã‚‰ESMã§æŒ‘æˆ¦ã—ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

## Refs

- [Read Node.js Source Code to Deeply Understand the CJS Module System - Alibaba Cloud Community](https://www.alibabacloud.com/blog/read-node-js-source-code-to-deeply-understand-the-cjs-module-system_599765)
- [requireã®ä»•çµ„ã¿ - ã¶ã‚Œã™ã¨ã¤ãƒ¼ã‚‹](https://nazomikan.hateblo.jp/entry/2014/12/23/212741)
- [javascript - How to stub require() / expect calls to the "root" function of a module?- Stack Overflow](https://stackoverflow.com/questions/6997459/how-to-stub-require-expect-calls-to-the-root-function-of-a-module#answer-7037187)
- [Modules: CommonJS modules | Node.js v20.4.0 Documentation](https://nodejs.org/api/modules.html#requireresolverequest-options)
- [node/lib/internal/modules/cjs/loader.js at v20.4.0 Â· nodejs/node Â· GitHub](https://github.com/nodejs/node/blob/v20.4.0/lib/internal/modules/cjs/loader.js)
- [NodeJS Modules - How to Load a Module with require()](https://www.encora.com/insights/nodejs-how-to-load-a-module-with-require)
- [Node.js ã® require ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹ã‚ˆ - ğŸ¾ Nekonote](https://scrapbox.io/dojineko/Node.js_%E3%81%AE_require_%E3%81%AF%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%81%95%E3%82%8C%E3%82%8B%E3%82%88)
